import AccountPersonalShow_pb2
import main_pb2
import FreeFire_pb2
import httpx
import asyncio
import json
from google.protobuf import json_format, message
from google.protobuf.message import Message
from Crypto.Cipher import AES
import base64
from typing import Tuple
import binascii
import time
from cachetools import TTLCache

MAIN_KEY = base64.b64decode('WWcmdGMlREV1aDYlWmNeOA==')
MAIN_IV = base64.b64decode('Nm95WkRyMjJFM3ljaGpNJQ==')
RELEASEVERSION = "OB50"
USERAGENT = "Free%20Fire/2019118692 CFNetwork/3826.500.111.2.2 Darwin/24.4.0"
SUPPORTED_REGIONS = ["IND", "BR", "SG", "RU", "ID", "TW", "US", "VN", "TH", "ME", "PK", "CIS"]

# Ø­Ø³Ø§Ø¨ API Ø§Ù„Ø¬Ø¯ÙŠØ¯
JWT_API_URL = "https://api-jwt-ag-team.vercel.app/get"

# Cache Ù„Ù„Ù€ JWT tokens (ÙŠØ¯ÙˆÙ… 4 Ø³Ø§Ø¹Ø§Øª)
jwt_cache = TTLCache(maxsize=10, ttl=4 * 60 * 60)  # 4 Ø³Ø§Ø¹Ø§Øª
last_request_time = 0
REQUEST_DELAY = 2  # ØªØ£Ø®ÙŠØ± 2 Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª

async def get_jwt_from_api(uid, password):
    """Ø¬Ù„Ø¨ JWT Ù…Ù† API Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© rate limiting"""
    global last_request_time
    
    # ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªØ¬Ù†Ø¨ rate limiting
    current_time = time.time()
    time_since_last_request = current_time - last_request_time
    if time_since_last_request < REQUEST_DELAY:
        await asyncio.sleep(REQUEST_DELAY - time_since_last_request)
    
    url = f"{JWT_API_URL}?uid={uid}&password={password}"
    print(f"ğŸ” Ø¬Ù„Ø¨ JWT Ù…Ù† API: {url}")
    
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(url)
        last_request_time = time.time()
        print(f"ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© JWT API: {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            print(f"ğŸ“¦ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: {data}")
            
            if data.get("status") == "success" and data.get("token"):
                return data["token"]
            elif data.get("status") == "error":
                error_msg = data.get("message", "Unknown error")
                if "too_many_requests" in error_msg:
                    raise Exception("Rate limit exceeded - please wait before making another request")
                else:
                    raise Exception(f"JWT API error: {error_msg}")
            else:
                raise Exception(f"Unexpected API response: {data}")
        else:
            raise Exception(f"JWT API returned status {response.status_code}")

async def create_jwt(region: str) -> Tuple[str, str, str]:
    try:
        print(f"ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ JWT Ù„Ù„Ù…Ù†Ø·Ù‚Ø©: {region}")
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ cache Ø£ÙˆÙ„Ø§Ù‹
        cache_key = f"jwt_{region}"
        if cache_key in jwt_cache:
            print(f"âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… JWT Ù…Ù† Ø§Ù„Ù€ cache Ù„Ù„Ù…Ù†Ø·Ù‚Ø©: {region}")
            token = jwt_cache[cache_key]
        else:
            # ØªØ¹Ø±ÙŠÙ UID Ùˆ Password Ù„ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©
            region_credentials = {
                'IND': ("3128851125", "A2E0175866917124D431D93C8F0179502108F92B9E22B84F855730F2E70ABEA4"),
                'SG': ("3158350464", "70EA041FCF79190E3D0A8F3CA95CAAE1F39782696CE9D85C2CCD525E28D223FC"),
                'RU': ("3301239795", "DD40EE772FCBD61409BB15033E3DE1B1C54EDA83B75DF0CDD24C34C7C8798475"),
                'ID': ("3301269321", "D11732AC9BBED0DED65D0FED7728CA8DFF408E174202ECF1939E328EA3E94356"),
                'TW': ("3301329477", "359FB179CD92C9C1A2A917293666B96972EF8A5FC43B5D9D61A2434DD3D7D0BC"),
                'US': ("3301387397", "BAC03CCF677F8772473A09870B6228ADFBC1F503BF59C8D05746DE451AD67128"),
                'VN': ("3301447047", "044714F5B9284F3661FB09E4E9833327488B45255EC9E0CCD953050E3DEF1F54"),
                'TH': ("3301470613", "39EFD9979BD6E9CCF6CBFF09F224C4B663E88B7093657CB3D4A6F3615DDE057A"),
                'ME': ("4210165885", "AlliFF_VIP-FGWA5U9Z4-AGTEAM"),
                'PK': ("3301828218", "3A0E972E57E9EDC39DC4830E3D486DBFB5DA7C52A4E8B0B8F3F9DC4450899571"),
                'CIS': ("3309128798", "412F68B618A8FAEDCCE289121AC4695C0046D2E45DB07EE512B4B3516DDA8B0F"),
                'BR': ("3158668455", "44296D19343151B25DE68286BDC565904A0DA5A5CC5E96B7A7ADBE7C11E07933")
            }
            
            if region not in region_credentials:
                raise Exception(f"Region {region} not supported")
            
            uid, password = region_credentials[region]
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¬Ù„Ø¨ JWT
            token = await get_jwt_from_api(uid, password)
            
            if not token:
                raise Exception("Failed to get token from JWT API")
            
            # ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ token ÙÙŠ Ø§Ù„Ù€ cache
            jwt_cache[cache_key] = token
            print(f"âœ… ØªÙ… ØªØ®Ø²ÙŠÙ† JWT ÙÙŠ Ø§Ù„Ù€ cache Ù„Ù„Ù…Ù†Ø·Ù‚Ø©: {region}")
        
        print(f"âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ JWT Ø¨Ù†Ø¬Ø§Ø­: {token[:50]}...")
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ³ÙŠØ±ÙØ± URL
        region_server = "EUROPE"
        server_url = "https://clientbp.ggblueshark.com"
        
        print(f"ğŸŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: {region_server}")
        print(f"ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: {server_url}")
        
        return f"Bearer {token}", region_server, server_url
            
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ create_jwt: {str(e)}")
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ token Ù…Ù† Ø§Ù„Ù€ cache Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠÙ‡ Ø®Ø·Ø£
        cache_key = f"jwt_{region}"
        if cache_key in jwt_cache:
            del jwt_cache[cache_key]
        raise e

async def json_to_proto(json_data: str, proto_message: Message) -> bytes:
    json_format.ParseDict(json.loads(json_data), proto_message)
    serialized_data = proto_message.SerializeToString()
    return serialized_data

def pad(text: bytes) -> bytes:
    padding_length = AES.block_size - (len(text) % AES.block_size)
    padding = bytes([padding_length] * padding_length)
    return text + padding

def aes_cbc_encrypt(key: bytes, iv: bytes, plaintext: bytes) -> bytes:
    aes = AES.new(key, AES.MODE_CBC, iv)
    padded_plaintext = pad(plaintext)
    ciphertext = aes.encrypt(padded_plaintext)
    return ciphertext

# Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† hex Ø¥Ù„Ù‰ protobuf
def decode_hex_protobuf(hex_data):
    """ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† hex Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† protobuf"""
    try:
        # ØªØ­ÙˆÙŠÙ„ hex Ø¥Ù„Ù‰ bytes
        byte_data = binascii.unhexlify(hex_data.replace(' ', ''))
        
        # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† protobuf ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        users = AccountPersonalShow_pb2.AccountPersonalShowInfo()
        users.ParseFromString(byte_data)
        
        return users
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ protobuf: {e}")
        raise e

async def GetAccountInformation(ID, UNKNOWN_ID, regionMain, endpoint):
    try:
        print(f"ğŸ‘¤ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨: ID={ID}, Region={regionMain}")
        
        json_data = json.dumps({
            "a": ID,
            "b": UNKNOWN_ID
        })
        
        encoded_result = await json_to_proto(json_data, main_pb2.GetPlayerPersonalShow())
        payload = aes_cbc_encrypt(MAIN_KEY, MAIN_IV, encoded_result)
        
        regionMain = regionMain.upper()
        if regionMain not in SUPPORTED_REGIONS:
            return {
                "error": "Invalid request",
                "message": f"Unsupported 'region' parameter. Supported regions are: {', '.join(SUPPORTED_REGIONS)}."
            }
        
        token, region, serverUrl = await create_jwt(regionMain)
        print(f"ğŸ”‘ Token: {token[:50]}...")
        print(f"ğŸŒ Server URL: {serverUrl}")
        
        headers = {
            "Host": "clientbp.ggblueshark.com",
            "X-Unity-Version": "2018.4.11f1",
            "Accept": "*/*",
            "Authorization": token,
            "ReleaseVersion": RELEASEVERSION,
            "X-GA": "v1 1",
            "Accept-Encoding": "gzip, deflate, br",
            "Accept-Language": "en-GB,en-US;q=0.9,en;q=0.8",
            "Content-Type": "application/octet-stream",
            "User-Agent": USERAGENT,
            "Connection": "keep-alive"
        }
        
        full_url = serverUrl + endpoint
        print(f"ğŸŒ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰: {full_url}")
        
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.post(full_url, data=payload, headers=headers)
            print(f"ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {response.status_code}")
            
            if response.status_code != 200:
                raise Exception(f"Server returned status {response.status_code}")
            
            response_content = response.content
            
            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ hex Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… ØªØ­Ù„ÙŠÙ„Ù‡
            hex_response = response_content.hex()
            print(f"ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©: {len(hex_response)} Ø­Ø±Ù hex")
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­ÙˆÙŠÙ„ protobuf
            message_obj = decode_hex_protobuf(hex_response)
            
            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† protobuf Ø¥Ù„Ù‰ JSON
            message_json = json_format.MessageToJson(message_obj)
            message_data = json.loads(message_json)
            
            print(f"âœ… ØªÙ… Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­")
            return message_data
            
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ GetAccountInformation: {str(e)}")
        raise e